import av
import io
import base64

from .common import TestCase


class TestDataStream(TestCase):
    def test_add_klv_stream(self):
        # base64-encoded bytes that describe a ts file with one klv stream containing one packet.
        template_str = (
            "R0AREABC8CUAAcEAAP8B/wAB/IAUSBIBBkZGbXBlZwlTZXJ2aWNlMDF3fEPK////////////////////////////"
            "////////////////////////////////////////////////////////////////////////////////////////"
            "//////////////////////////////////////////////////////////////////////////9HQAAQAACwDQAB"
            "wQAAAAHwACqxBLL/////////////////////////////////////////////////////////////////////////"
            "////////////////////////////////////////////////////////////////////////////////////////"
            "/////////////////////////////////////////////////////////////0dQABAAArAYAAHBAADhAPAABuEA"
            "8AYFBEtMVkEbIMiL////////////////////////////////////////////////////////////////////////"
            "////////////////////////////////////////////////////////////////////////////////////////"
            "////////////////////////////////////////////////R0EAMKhQAAAAAH4A////////////////////////"
            "////////////////////////////////////////////////////////////////////////////////////////"
            "////////////////////////////////////////////////////////////////////////////////////////"
            "//////////////8AAAH8AAmEgAUhAAEAAQA="
        )

        template_data = base64.b64decode(template_str)
        template_file = io.BytesIO(template_data)
        template_context = av.open(template_file)

        out_file = io.BytesIO()
        out_context = av.open(out_file, 'w', format='mpegts')
        self.assertEqual(0, len(out_context.streams.data))
        out_context.add_stream(template=template_context.streams.data[0])
        self.assertEqual(1, len(out_context.streams.data))
        self.assertEqual('klv', out_context.streams.data[0].name)

        template_context.close()
        out_context.close()

        template_file.close()
        out_file.close()
